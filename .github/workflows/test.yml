name: Emoji Nuker Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Validate historical precedence architecture
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          from emoji_lut import PRE_EMOJI_UNICODE_SYMBOLS, is_emoji_for_replacement
          
          print('=== Historical Precedence Architecture Validation ===')
          print('Testing that pre-emoji Unicode symbols are NOT treated as emojis for replacement...')
          
          # Test pre-emoji Unicode symbols
          test_symbols = [
              (0x002A, '*', 'Asterisk (ASCII â†’ keycap emoji component)'),
              (0x0023, '#', 'Hash/Number Sign (ASCII â†’ keycap emoji component)'),
              (0x2139, 'â„¹', 'Information Source (Unicode 3.0 â†’ Emoji 1.0)'),
              (0x2122, 'â„¢', 'Trade Mark Sign (Unicode 1.1 â†’ Emoji 1.0)'),
              (0x00A9, 'Â©', 'Copyright Sign (Unicode 1.1 â†’ Emoji 1.0)'),
              (0x00AE, 'Â®', 'Registered Sign (Unicode 1.1 â†’ Emoji 1.0)'),
              (0x2190, 'â†', 'Leftwards Arrow'),
              (0x2191, 'â†‘', 'Upwards Arrow'),
              (0x2192, 'â†’', 'Rightwards Arrow'),
              (0x2193, 'â†“', 'Downwards Arrow'),
              (0x2194, 'â†”', 'Left Right Arrow'),
              (0x2195, 'â†•', 'Up Down Arrow'),
              (0x2196, 'â†–', 'North West Arrow'),
              (0x2197, 'â†—', 'North East Arrow'),
              (0x2198, 'â†˜', 'South East Arrow'),
              (0x2199, 'â†™', 'South West Arrow'),
              (0x2713, 'âœ“', 'Check Mark'),
              (0x2717, 'âœ—', 'Ballot X'),
              (0x221A, 'âˆš', 'Square Root'),
              (0x00D7, 'Ã—', 'Multiplication Sign'),
              (0x0021, '!', 'Exclamation Mark'),
              (0x706B, 'ç«', 'CJK Unified Ideograph (fire)'),
          ]
          
          failed_tests = []
          for codepoint, symbol, description in test_symbols:
              if codepoint not in PRE_EMOJI_UNICODE_SYMBOLS:
                  failed_tests.append(f'{symbol} (U+{codepoint:04X}) missing from PRE_EMOJI_UNICODE_SYMBOLS')
                  continue
              
              is_emoji = is_emoji_for_replacement(symbol)
              if is_emoji:
                  failed_tests.append(f'{symbol} (U+{codepoint:04X}) incorrectly treated as emoji: {description}')
              else:
                  print(f'âœ“ {symbol} (U+{codepoint:04X}) correctly preserved: {description}')
          
          if failed_tests:
              print('\nFAILED TESTS:')
              for failure in failed_tests:
                  print(f'âœ— {failure}')
              sys.exit(1)
          
          print('\nâœ“ All historical precedence tests passed!')
          print(f'Total pre-emoji Unicode symbols tested: {len(test_symbols)}')
          "

      - name: Validate emoji substitutions
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          with open('src/emoji-nuker', 'r') as f:
              content = f.read()
          exec(content.split('def main()')[0])
          
          print('=== Emoji Substitution Validation ===')
          print('Validating that no emoji characters are used in substitutions...')
          
          result = validate_no_emoji_in_substitutions()
          if not result:
              sys.exit(1)
          "

      - name: Create comprehensive test input file
        run: |
          cat > test_emoji_input.py << 'EOF'
          #!/usr/bin/env python3
          """
          Comprehensive test file for emoji-nuker historical precedence architecture
          
          This file tests the distinction between:
          1. Pre-emoji Unicode symbols (should NOT be replaced)
          2. Emoji-first characters (should be replaced)
          """
          
          # === PRE-EMOJI UNICODE SYMBOLS (should NOT be replaced) ===
          print("ASCII symbols that became keycap components: * #")
          print("Unicode symbols that later became emojis: â„¹ â„¢ Â© Â®")
          print("Directional arrows: â† â†’ â†‘ â†“")
          print("Diagonal arrows: â†— â†˜ â†™ â†–")
          print("Up-down arrows: â†• â†”")
          print("Math symbols: âœ“ âœ— âˆš Ã— !")
          print("CJK characters: ç«")
          
          # === EMOJI-FIRST CHARACTERS (should be replaced) ===
          print("Status emojis: âœ… Success, âŒ Failed")
          print("Symbols: ðŸ”¥ Fire, âš  Warning, â­ Star")
          print("Arrow emoji: âž¡ Right arrow")
          print("Triangle emojis: ðŸ”º Up triangle, ðŸ”» Down triangle")
          print("Numbers: 1ï¸âƒ£ 2ï¸âƒ£ 3ï¸âƒ£")
          print("Letters: ðŸ…° ðŸ…± ðŸ…¾")
          print("Faces: ðŸ˜€ ðŸ˜Š ðŸ˜‰ ðŸ˜¢")
          print("Rocket: ðŸš€")
          
          def test_function():
              """Function with mixed symbols and emojis"""
              # These should NOT be replaced (pre-emoji Unicode symbols)
              result = "Status: âœ“ passed, âœ— failed"
              result += " Direction: â† â†’ â†‘ â†“ â†— â†˜ â†™ â†– â†• â†”"
              result += " Math: âˆš Ã— ! Info: â„¹ Trademark: â„¢"
              result += " Copyright: Â© Registered: Â® Fire: ç«"
              
              # These SHOULD be replaced (emoji-first characters)
              result += " Emoji status: âœ… âŒ ðŸ”¥ âš  â­ âž¡ ðŸ”º ðŸ”» ðŸš€"
              
              return result
          
          # Comments with mixed symbols
          # Pre-emoji Unicode: âœ“ âœ— â† â†’ â†‘ â†“ â†— â†˜ â†™ â†– â†• â†” * # â„¹ â„¢ Â© Â® âˆš Ã— ! ç«
          # Emoji-first: âœ… âŒ ðŸ”¥ âš  â­ âž¡ ðŸ”º ðŸ”» ðŸš€ ðŸ˜€ ðŸ˜Š ðŸ˜‰ ðŸ˜¢ 1ï¸âƒ£ ðŸ…°
          EOF

      - name: Test historical precedence in substitution mode
        run: |
          cp test_emoji_input.py test_precedence_output.py
          python3 src/emoji-nuker --substitute test_precedence_output.py
          
          # Verify pre-emoji Unicode symbols were NOT replaced
          echo "Checking that pre-emoji Unicode symbols were preserved..."
          
          symbols_to_check=("âœ“" "âœ—" "â†" "â†’" "â†‘" "â†“" "â†—" "â†˜" "â†™" "â†–" "â†•" "â†”" "*" "#" "â„¹" "â„¢" "Â©" "Â®" "âˆš" "Ã—" "!" "ç«")
          
          for symbol in "${symbols_to_check[@]}"; do
              if grep -q "$symbol" test_precedence_output.py; then
                  echo "âœ“ Pre-emoji Unicode symbol '$symbol' correctly preserved"
              else
                  echo "âœ— Pre-emoji Unicode symbol '$symbol' was incorrectly replaced"
                  exit 1
              fi
          done
          
          # Verify emoji-first characters were replaced (should not be present)
          emojis_to_check=("âœ…" "âŒ" "ðŸ”¥" "âš " "â­" "âž¡" "ðŸ”º" "ðŸ”»" "ðŸš€" "ðŸ˜€" "ðŸ˜Š" "ðŸ˜‰" "ðŸ˜¢" "1ï¸âƒ£" "ðŸ…°")
          
          for emoji in "${emojis_to_check[@]}"; do
              if grep -q "$emoji" test_precedence_output.py; then
                  echo "âœ— Emoji-first character '$emoji' was not replaced"
                  exit 1
              else
                  echo "âœ“ Emoji-first character '$emoji' correctly replaced"
              fi
          done
          
          echo "âœ“ Historical precedence architecture working correctly!"

      - name: Test basic substitution functionality
        run: |
          cp test_emoji_input.py test_emoji_output.py
          python3 src/emoji-nuker --substitute test_emoji_output.py
          echo "âœ“ Basic substitution test completed"

      - name: Test interactive mode
        run: |
          python3 src/emoji-nuker --interactive test_emoji_input.py
          echo "âœ“ Interactive mode test completed"

      - name: Test labeling mode
        run: |
          cp test_emoji_input.py test_emoji_label.py
          python3 src/emoji-nuker --label test_emoji_label.py
          echo "âœ“ Label mode test completed"

      - name: Test combined substitute and label mode
        run: |
          cp test_emoji_input.py test_emoji_combined.py
          python3 src/emoji-nuker --substitute --label test_emoji_combined.py
          echo "âœ“ Combined mode test completed"

      - name: Test color substitution mode
        run: |
          cp test_emoji_input.py test_emoji_color.py
          python3 src/emoji-nuker --substitute --color test_emoji_color.py
          echo "âœ“ Color mode test completed"

      - name: Verify key substitutions
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          with open('src/emoji-nuker', 'r') as f:
              content = f.read()
          exec(content.split('def main()')[0])
          
          print('=== Key Substitution Verification ===')
          # Test key substitutions
          key_tests = [
              ('âœ…', 'âœ“', 'Green checkmark'),
              ('âŒ', 'âœ—', 'Red cross'),
              ('ðŸ”¥', 'ç«', 'Fire emoji'),
              ('âš ', '!', 'Warning'),
              ('â­', '*', 'Star'),
              ('âž¡', 'â†’', 'Right arrow emoji'),
              ('ðŸ”º', 'â–²', 'Up triangle'),
              ('ðŸ”»', 'â–¼', 'Down triangle'),
          ]
          
          print('Testing key substitutions:')
          for emoji, expected, name in key_tests:
              if emoji in BASE_SUBSTITUTIONS:
                  actual = BASE_SUBSTITUTIONS[emoji]
                  if actual == expected:
                      print(f'âœ“ {name}: {emoji} â†’ {actual}')
                  else:
                      print(f'âœ— {name}: {emoji} â†’ {actual} (expected {expected})')
                      sys.exit(1)
              else:
                  print(f'âœ— {name}: {emoji} not found in substitutions')
                  sys.exit(1)
          print('âœ“ All key substitutions verified!')
          "

      - name: Test smart substitution builder
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          with open('src/emoji-nuker', 'r') as f:
              content = f.read()
          exec(content.split('def main()')[0])
          
          print('=== Smart Substitution Builder Testing ===')
          # Test smart substitution builder
          builder = SmartSubstitutionBuilder()
          
          # Test emoticon conversion
          emoticon_tests = [
              ('ðŸ˜€', ':D'),
              ('ðŸ˜Š', ':)'),
              ('ðŸ˜‰', ';)'),
              ('ðŸ˜¢', ':\'('),
          ]
          
          print('Testing emoticon conversion:')
          for emoji, expected in emoticon_tests:
              result = builder.build_substitution(emoji)
              if result == expected:
                  print(f'âœ“ {emoji} â†’ {result}')
              else:
                  print(f'âœ— {emoji} â†’ {result} (expected {expected})')
                  sys.exit(1)
          print('âœ“ Smart substitution builder verified!')
          "

      - name: Test comprehensive emoji detection
        run: |
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          from emoji_lut import is_emoji_for_replacement
          
          print('=== Comprehensive Emoji Detection Testing ===')
          
          # Test that known emojis are detected
          known_emojis = ['ðŸ˜€', 'ðŸš€', 'âœ…', 'âŒ', 'ðŸ”¥', 'âš ', 'â­', 'âž¡', 'ðŸ”º', 'ðŸ”»', '1ï¸âƒ£', 'ðŸ…°']
          print('Testing emoji detection:')
          for emoji in known_emojis:
              if is_emoji_for_replacement(emoji):
                  print(f'âœ“ {emoji} correctly detected as emoji')
              else:
                  print(f'âœ— {emoji} not detected as emoji')
                  sys.exit(1)
          
          # Test that pre-emoji Unicode symbols are NOT detected as emojis
          unicode_symbols = ['âœ“', 'âœ—', 'â†', 'â†’', 'â†‘', 'â†“', 'â†—', 'â†˜', 'â†™', 'â†–', 'â†•', 'â†”', '*', '#', 'â„¹', 'â„¢', 'Â©', 'Â®', 'âˆš', 'Ã—', '!', 'ç«']
          print('Testing Unicode symbol safety:')
          for symbol in unicode_symbols:
              if not is_emoji_for_replacement(symbol):
                  print(f'âœ“ {symbol} correctly preserved as Unicode symbol')
              else:
                  print(f'âœ— {symbol} incorrectly detected as emoji')
                  sys.exit(1)
          
          print('âœ“ Comprehensive emoji detection tests passed!')
          "

      - name: Clean up test files
        run: |
          rm -f test_emoji_input.py test_emoji_output.py test_emoji_label.py test_emoji_combined.py test_emoji_color.py test_precedence_output.py

      - name: Success
        if: success()
        run: |
          echo 'All Emoji Nuker tests passed!'
          echo ''
          echo '=== Test Summary ==='
          echo 'âœ“ Historical precedence architecture validated'
          echo 'âœ“ Pre-emoji Unicode symbols preserved'
          echo 'âœ“ Emoji-first characters correctly replaced'
          echo 'âœ“ All operation modes tested'
          echo 'âœ“ Smart substitution builder verified'
          echo 'âœ“ Comprehensive emoji detection validated' 